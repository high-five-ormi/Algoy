<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link th:href="@{/css/signup/signup.css}" rel="stylesheet">
    <title>회원가입</title>
</head>
<body>
    <h1>회원가입</h1>
    <form th:action="@{/algoy/sign}" th:object="${user}" method="post">
        <label for="email">E-amil</label>
        <div class="input-group">
            <input type="email" id="email" th:field="*{email}" placeholder="이메일을 입력하세요." required/>
            <button type="button" class="check-button" onclick="checkDuplicateEmail(event)">중복 확인</button>
        </div>
        <p id="email-message" class="view-message"></p>

        <label for="password">Password</label>
        <input type="password" id="password" th:field="*{password}" placeholder="비밀번호를 입력하세요." required/>

        <label for="confirm-password">Re-enter Password</label>
        <input type="password" id="confirm-password" name="confirmPassword" placeholder="비밀번호를 입력하세요." required/>
        <p th:if="${passwordMismatch}" class="view-message">비밀번호가 일치하지 않습니다!</p>

        <label for="username">이름</label>
        <input type="text" id="username" th:field="*{username}" placeholder="이름을 입력하세요." required/>

        <label for="nickname">닉네임</label>
        <div class="input-group">
            <input type="text" id="nickname" th:field="*{nickname}" placeholder="닉네임을 입력하세요." required/>
            <button type="button" class="check-button" onclick="checkDuplicateNickname(event)">중복 확인</button>
        </div>
        <p id="nickname-message" class="view-message"></p>

        <div class="btn-wrap">
            <button type="submit" class="submit-button">회원 가입</button>
            <button type="button" class="back-button">뒤로 가기</button>
        </div>
    </form>
    <script>
        /* --------------- e-mail check --------------- */
        function checkDuplicateEmail(event) {
            event.preventDefault(); // 폼의 기본 제출 동작 막기

            const email = document.getElementById("email").value; // 사용자가 입력한 값
            const emailMessage = document.getElementById("email-message"); // 메시지를 표시할 요소

            // 기본적인 이메일 유효성 검사를 위한 정규 표현식
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!email) { // 입력한 값이 없으면
                emailMessage.textContent = "이메일을 입력하세요.";
                emailMessage.style.color = "red";
            } else if (!emailRegex.test(email)) { // 입력한 값이 유효하지 않으면
                emailMessage.textContent = "유효한 이메일 주소를 입력하세요.";
                emailMessage.style.color = "red";
            } else { // 입력한 값이 유효한 경우 중복 검사
                // fetch API를 사용하여 서버에 GET 요청 보내기
                fetch(`/algoy/check-email-duplicate?email=${encodeURIComponent(email)}`)
                    .then(response => {
                        // 서버 응답이 성공적인지 확인 (HTTP 상태 코드가 200번대인지 확인)
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json(); // 응답 본문을 JSON으로 파싱하여 반환
                    })
                    .then(data => {
                        // 서버에서 반환된 데이터에 'exists' 필드가 있는지 확인하여 이메일 중복 여부 판단
                        if (data.exists) { // 입력한 이메일이 이미 존재하는 경우
                            emailMessage.textContent = "이미 사용 중인 이메일입니다!";
                            emailMessage.style.color = "red";
                        } else { // 입력한 이메일이 이미 존재하지 않는(사용 가능한) 경우
                            emailMessage.textContent = "사용 가능한 이메일입니다!";
                            emailMessage.style.color = "green";
                        }
                    })
                    .catch(error => { // fetch 요청 또는 JSON 파싱 중 오류가 발생한 경우
                        console.error("Error checking email:", error);
                        emailMessage.textContent = "이메일 확인 중 오류가 발생했습니다.";
                        emailMessage.style.color = "red";
                    });
            }
        }

        /* --------------- nickname check --------------- */
        function checkDuplicateNickname(event) {
            event.preventDefault(); // 폼의 기본 제출 동작 막기

            const nickname = document.getElementById("nickname").value; // 사용자가 입력한 값
            const nicknameMessage = document.getElementById("nickname-message"); // 메시지를 표시할 요소

            // 닉네임 입력란에 값이 있는지 확인
            if (nickname) { // 닉네임 입력란에 값이 있으면
                // fetch API를 사용하여 서버에 GET 요청 보내기
                fetch(`/algoy/check-nickname-duplicate?nickname=${encodeURIComponent(nickname)}`)
                    .then(response => {
                        // 서버 응답이 성공적인지 확인 (HTTP 상태 코드가 200번대인지 확인)
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json(); // 응답 본문을 JSON으로 파싱하여 반환
                    })
                    .then(data => {
                        // 서버에서 반환된 데이터에 'exists' 필드가 있는지 확인하여 닉네임 중복 여부 판단
                        if (data.exists) { // 입력한 닉네임이 이미 존재하는 경우
                            nicknameMessage.textContent = "이미 사용 중인 닉네임입니다!";
                            nicknameMessage.style.color = "red";
                        } else { // 입력한 닉네임이 이미 존재하지 않는(사용 가능한) 경우
                            nicknameMessage.textContent = "사용 가능한 닉네임입니다!";
                            nicknameMessage.style.color = "green";
                        }
                    })
                    .catch(error => { // fetch 요청 또는 JSON 파싱 중 오류가 발생한 경우
                        console.error("Error checking email:", error);
                        nicknameMessage.textContent = "닉네임 확인 중 오류가 발생했습니다.";
                        nicknameMessage.style.color = "red";
                    });
            } else { // 입력란이 비어있으면
                nicknameMessage.textContent = "사용하실 닉네임을 입력하세요.";
                nicknameMessage.style.color = "red";
            }
        }
    </script>
    <script th:src="@{/js/main.js}"></script>
</body>
</html>